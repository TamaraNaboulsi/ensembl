name: New Testing Workflow

on:
  push:
    branches:
      - github_actions_testing

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        perl: ['5.14', '5.26', '5.30']
        coveralls: [true, false]
        database: [mysql, sqlite]
#        include:
#           - perl: '5.30'
#             container: 'tamaranaboulsi/test-repo:perl-5.030.004-custom'
#             coveralls: false
#             DB: mysql
        exclude:
          - perl: '5.14'
            coveralls: true
          - perl: '5.14'
            coveralls: false
            database: mysql
          - perl: '5.26'
            coveralls: false
          - perl: '5.26'
            coveralls: true
            database: sqlite
          - perl: 5.30
            coveralls: true
          - perl: 5.30
            coveralls: false
            database: sqlite
    
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: secret
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        ports:
            - '8888:3306'
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: Checkout
        uses: actions/checkout@master
      
      - name: Set up perl ${{ matrix.perl }}
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl }}
      
      - name: Clone repos
        run: |
          git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-test.git
          git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-io.git
          git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-variation.git
          git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-compara.git
          git clone -b release-1-6-924 --depth 1 https://github.com/bioperl/bioperl-live.git
      
      - name: Install dependencies
        run: |
          cpanm -v --sudo --installdeps --notest . --with-all-features
          cpanm -n --sudo Devel::Cover Devel::Cover::Report::Coveralls Test::Exception Moose Devel::Cycle Test::Warnings
          cpanm -n --sudo DBD::SQLite JSON
      
      - name: Copy mysql/sqlite conf files
        run: |
          cp travisci/MultiTestDB.conf.actions.mysql modules/t/MultiTestDB.conf.mysql
          cp travisci/MultiTestDB.conf.actions.SQLite modules/t/MultiTestDB.conf.SQLite
          cp travisci/testdb.conf.actions.mysql testdb.conf.mysql
          cp travisci/testdb.conf.actions.SQLite testdb.conf.SQLite
          cp travisci/edited_runtests.pl ensembl-test/scripts/runtests.pl
      
      - name: Configure mysql
        run: |
          sudo service mysql start
          mysql -e "CREATE USER 'github'@'%'" -u root -psecret -h 127.0.0.1 --port 8888
          mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'github'@'%'" -u root -psecret -h 127.0.0.1 --port 8888
          mysql -e "SET GLOBAL local_infile=1" -u root -psecret -h 127.0.0.1 --port 8888
      
      - name: Run Test Suite
        env:
          DB: ${{ matrix.database }}
          COVERALLS: false
          USER: 'github'
        run: ./travisci/harness.sh






# jobs:
#   run-tests:
#     name: Run Tests
#     runs-on: ubuntu-latest
#     container: ${{ matrix.container }}
    
#     strategy:
#       matrix:
#         perl: ['5.14', '5.26', '5.30']
#         #perl: ['5.14', '5.30']
#         COVERALLS: [true, false]
#         DB: [mysql, sqlite]
#         container: ['tamaranaboulsi/test-repo:perl-5.014.004-custom']
        
#         include:
#           - perl: '5.30'
#             container: 'tamaranaboulsi/test-repo:perl-5.030.004-custom'
#             COVERALLS: false
#             DB: mysql
#         exclude:
#           - perl: '5.14'
#             COVERALLS: false
#             DB: mysql
#           - perl: '5.14'
#             COVERALLS: true
#             DB: mysql
#           - perl: '5.14'
#             COVERALLS: true
#             DB: sqlite
#           - perl: '5.26'
#             COVERALLS: false
#             DB: sqlite
#           - perl: '5.26'
#             COVERALLS: false
#             DB: mysql
#           - perl: '5.26'
#             COVERALLS: true
#             DB: sqlite
#           - perl: '5.30'
#             COVERALLS: false
#             DB: sqlite
#             container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
#           - perl: '5.30'
#             COVERALLS: false
#             DB: mysql
#             container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
#           - perl: '5.30'
#             COVERALLS: true
#             DB: mysql
#             container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
#           - perl: '5.30'
#             COVERALLS: true
#             DB: sqlite
#             container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
    
#     env:
#       AUTH_TOKEN: Ju069PzB8QZG3302emIhyCEEQfVfVsiXy0nGcR6hue+vW9nE82NnOEZHbZIwUCXEjUaZRMVQ31Em70Ky22OrLK4D59bs2ClH21u8URDGD/cn7JNPGWFrgxuaXQKMQrw72doeB0+w1+ShURtqM41vITjinyU3y34RZ1NcbDwYSZI=

#     steps:
#       - name: Checkout
#         uses: actions/checkout@master
      
#       - name: Before Script
#         run: |
#           apt update && apt install sudo
#           sudo apt update
#           apt-get install -y default-mysql-server
      
#       - name: Clone repos
#         run: |
#           git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-test.git
#           git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-io.git
#           git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-variation.git
#           git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-compara.git
#           git clone -b release-1-6-924 --depth 1 https://github.com/bioperl/bioperl-live.git
      
#       - uses: perl-actions/install-with-cpanm@v1
#         name: Install dependencies
#         with:
#           cpanfile: "cpanfile"
#           sudo: false
#           verbose: true
#           install: |
#             Devel::Cover
#             Devel::Cover::Report::Coveralls
#             Test::Exception
#             Moose
#             Devel::Cycle
#             Test::Warnings
#             DBD::SQLite
#             JSON
#             namespace::autoclean
#             Config::General
#             DBIx::Class::Schema
#             Text::Glob
#             Text::CSV
#             SQL::Translator
      
#       - name: Copy mysql/sqlite conf files
#         run: |
#           cp travisci/MultiTestDB.conf.actions.mysql modules/t/MultiTestDB.conf.mysql
#           cp travisci/MultiTestDB.conf.actions.SQLite modules/t/MultiTestDB.conf.SQLite
#           cp travisci/testdb.conf.actions.mysql testdb.conf.mysql
#           cp travisci/testdb.conf.actions.SQLite testdb.conf.SQLite
      
#       - name: Configure mysql
#         env:
#           DB_PORT: ${{ job.services.mysql.ports['3306'] }}
#         run: |
#           service mysql start
#           mysql -e "CREATE USER 'github'@'%'" -u root -h localhost
#           mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'github'@'%'" -u root -h localhost
#           mysql -e "SET GLOBAL local_infile=1" -u root -h localhost
      
#       - name: Run Test Suite
#         env:
#           DB: ${{ matrix.DB }}
#           COVERALLS: ${{ matrix.COVERALLS }}
#           USER: 'github'
#         run: ./travisci/harness.sh

#       - if: ${{ matrix.COVERALLS }}
#         name: Coveralls
#         uses: coverallsapp/github-action@master
#         with:
#           github-token: ${{ secrets.GITHUB_TOKEN }}
