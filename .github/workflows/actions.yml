name: Testing Workflow

on:
  push:
    branches:
      - master

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    container: ${{ matrix.container }}
    
    services:
      mysql:
        image: mysql:latest
        ports:
          - 3306
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        options: --health-cmd "mysqladmin ping" --health-interval 10s --health-timeout 5s --health-retries 10
    
    strategy:
      matrix:
        perl: ['5.14', '5.26', '5.30']
        env: [COVERALLS=true DB=mysql, COVERALLS=false DB=mysql, COVERALLS=false DB=sqlite]
        container: ['tamaranaboulsi/test-repo:perl-5.014.004-custom']
        
        include:
          - perl: '5.30'
            container: 'tamaranaboulsi/test-repo:perl-5.030.004-custom'
            env: COVERALLS=false DB=mysql
        exclude:
          - perl: '5.14'
            env: COVERALLS=false DB=mysql
          - perl: '5.14'
            env: COVERALLS=true DB=mysql
          - perl: '5.26'
            env: COVERALLS=false DB=sqlite
          - perl: '5.26'
            env: COVERALLS=false DB=mysql
          - perl: '5.30'
            container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
            env: COVERALLS=false DB=sqlite
          - perl: '5.30'
            container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
            env: COVERALLS=false DB=mysql
          - perl: '5.30'
            container: 'tamaranaboulsi/test-repo:perl-5.014.004-custom'
            env: COVERALLS=true DB=mysql
    
    env:
      AUTH_TOKEN: Ju069PzB8QZG3302emIhyCEEQfVfVsiXy0nGcR6hue+vW9nE82NnOEZHbZIwUCXEjUaZRMVQ31Em70Ky22OrLK4D59bs2ClH21u8URDGD/cn7JNPGWFrgxuaXQKMQrw72doeB0+w1+ShURtqM41vITjinyU3y34RZ1NcbDwYSZI=

    steps:
      - name: Checkout
        uses: actions/checkout@master
      
      - name: Perl ${{ matrix.perl }} Setup
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl }}
